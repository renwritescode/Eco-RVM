{% extends 'base.html' %}

{% block title %}Recompensas - Eco-RVM{% endblock %}

{% block content %}
<div class="container-fluid pb-5">
    <!-- Header con puntos del usuario -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card border-0 shadow-lg overflow-hidden position-relative"
                style="background: var(--gradient-primary); border-radius: 20px;">
                <!-- Decorativo de fondo -->
                <div class="position-absolute bottom-0 start-0 rounded-circle bg-white"
                    style="width: 250px; height: 250px; transform: translate(-30%, 30%); opacity: 0.05;"></div>

                <div
                    class="card-body p-4 p-lg-5 text-white position-relative z-1 d-flex justify-content-between align-items-center flex-wrap">
                    <div>
                        <h1 class="display-5 fw-bold mb-1">
                            <i class="bi bi-gift-fill me-2"></i>Cat√°logo de Premios
                        </h1>
                        <p class="mb-0 opacity-90 lead">
                            Tus esfuerzos tienen recompensa. ¬°Canjea tus puntos aqu√≠!
                        </p>
                    </div>
                    <div class="text-center mt-3 mt-lg-0">
                        <div class="bg-white bg-opacity-25 rounded-4 p-3 px-4 backdrop-blur">
                            <h2 class="display-4 fw-bold mb-0 text-white">
                                <i class="bi bi-coin me-2 text-warning filter-drop-shadow"></i>{{ puntos_usuario }}
                            </h2>
                            <small class="text-uppercase fw-bold letter-spacing-1">Puntos Disponibles</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if recompensas %}
    <div class="row g-4">
        {% for r in recompensas %}
        <div class="col-md-6 col-lg-4 col-xl-3">
            <div class="card h-100 border-0 shadow-sm transition-hover {{ 'bg-dimmed' if puntos_usuario < r.puntos_requeridos else 'bg-white' }}"
                style="border-radius: 20px;">

                <div class="card-body p-4 d-flex flex-column text-center position-relative overflow-hidden">
                    {% if r.stock <= 0 %} <div
                        class="position-absolute top-0 end-0 bg-danger text-white px-3 py-1 rounded-bl-3 fw-bold small">
                        AGOTADO</div>
                {% elif r.stock <= 5 %} <div
                    class="position-absolute top-0 end-0 bg-warning text-dark px-3 py-1 rounded-bl-3 fw-bold small">
                    ¬°√öLTIMOS!
            </div>
            {% endif %}

            <!-- Icono de categor√≠a -->
            <div class="mx-auto mb-4 p-4 rounded-circle bg-light shadow-inner d-flex align-items-center justify-content-center animate-float"
                style="width: 100px; height: 100px;">
                <span class="display-3">
                    {% if r.categoria == 'comida' %}‚òï{% elif r.categoria == 'descuentos' %}üè∑Ô∏è{% elif r.categoria ==
                    'entretenimiento' %}üé¨{% elif r.categoria == 'productos' %}üéÅ{% elif r.categoria == 'donacion'
                    %}üíö{% else %}üéØ{% endif %}
                </span>
            </div>

            <h5 class="fw-bold mb-2 text-dark">{{ r.nombre }}</h5>
            <p class="text-muted small mb-3 flex-grow-1">{{ r.descripcion }}</p>

            <div class="mb-3">
                <span class="badge border border-light text-dark bg-light rounded-pill px-3 py-1">{{
                    r.categoria|capitalize }}</span>
            </div>

            <div class="mb-4">
                <h3 class="fw-bold {{ 'text-success' if puntos_usuario >= r.puntos_requeridos else 'text-danger' }}">
                    {{ r.puntos_requeridos }} <small class="fs-6 text-muted">pts</small>
                </h3>
            </div>

            <div class="mt-auto">
                {% if r.disponible and puntos_usuario >= r.puntos_requeridos and r.stock > 0 %}
                <button class="btn btn-success w-100 rounded-pill fw-bold shadow-sm py-2" data-id="{{ r.id }}"
                    data-nombre="{{ r.nombre }}" data-puntos="{{ r.puntos_requeridos }}" onclick="confirmarCanje(this)"
                    style="background: var(--gradient-primary); border: none;">
                    <i class="bi bi-cart-plus me-1"></i>Canjear
                </button>
                {% elif r.stock <= 0 %} <button class="btn btn-secondary w-100 rounded-pill fw-bold py-2 disabled"
                    disabled style="opacity: 0.7;">
                    <i class="bi bi-emoji-frown me-1"></i>Agotado
                    </button>
                    {% else %}
                    <button class="btn btn-outline-secondary w-100 rounded-pill fw-bold py-2" disabled
                        style="border-style: dashed;">
                        <i class="bi bi-lock me-1"></i>Faltan {{ r.puntos_requeridos - puntos_usuario }} pts
                    </button>
                    {% endif %}
            </div>
        </div>
    </div>
</div>
{% endfor %}
</div>
{% else %}
<div class="text-center py-5">
    <div class="bg-light rounded-circle d-inline-flex p-4 mb-3">
        <i class="bi bi-gift text-muted opacity-50 display-4"></i>
    </div>
    <h5 class="text-muted fw-bold">No hay recompensas disponibles por ahora</h5>
    <p class="text-muted">¬°Vuelve pronto para ver nuevas sorpresas!</p>
</div>
{% endif %}
</div>

<!-- Modal de Confirmaci√≥n de Canje -->
<div class="modal fade" id="modalCanje" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
            <div class="modal-header border-0 bg-success text-white"
                style="background: var(--gradient-primary); border-radius: 20px 20px 0 0;">
                <h5 class="modal-title fw-bold">
                    <i class="bi bi-gift-fill me-2"></i>Confirmar Canje
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="form-canjear" method="POST" action="">
                <div class="modal-body p-4 text-center">
                    <p class="mb-2 text-muted uppercase tracking-wide small fw-bold">Est√°s a punto de canjear:</p>
                    <h3 id="modal-recompensa-nombre" class="fw-bold text-dark mb-4">-</h3>

                    <div class="d-flex justify-content-center align-items-center mb-4">
                        <div class="text-center px-4 border-end">
                            <div class="text-muted small">Costo</div>
                            <div class="fs-4 fw-bold text-danger">-<span id="modal-puntos">0</span></div>
                        </div>
                        <div class="text-center px-4">
                            <div class="text-muted small">Saldo Final</div>
                            <div class="fs-4 fw-bold text-success" id="modal-puntos-restantes">0</div>
                        </div>
                    </div>

                    <div class="alert alert-soft-info border-0 d-flex align-items-center justify-content-center"
                        style="background: rgba(13, 202, 240, 0.1); color: #055160;">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        <small>Esta acci√≥n no se puede deshacer.</small>
                    </div>
                </div>
                <div class="modal-footer border-0 justify-content-center pb-4">
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-success rounded-pill px-4 fw-bold shadow-sm"
                        style="background: var(--gradient-primary); border: none;">
                        <i class="bi bi-check2-circle me-1"></i>Confirmar Canje
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Convertir a n√∫mero seguro para evitar errores de linter
    const puntosUsuario = Number('{{ puntos_usuario }}');

    function confirmarCanje(btn) {
        // Leer datos del bot√≥n (dataset)
        const id = btn.dataset.id;
        const nombre = btn.dataset.nombre;
        const puntos = Number(btn.dataset.puntos);

        document.getElementById('modal-recompensa-nombre').textContent = nombre;
        document.getElementById('modal-puntos').textContent = puntos;
        document.getElementById('modal-puntos-restantes').textContent = puntosUsuario - puntos;

        // Actualizar la acci√≥n del formulario
        document.getElementById('form-canjear').action = '/canjear/' + id;

        const modal = new bootstrap.Modal(document.getElementById('modalCanje'));
        modal.show();
    }
</script>
{% endblock %}